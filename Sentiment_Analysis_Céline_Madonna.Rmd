---
title: "Sentiment_Analysis_DS4"
author: "Agnes Kollaine Stark"
date: "5/4/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

My project is going to be a sentiment analysis of Céline Dion's album of 1999 : "All the Way... a Decade of Song" versus Madonna's album of 1998: "Ray of Light".

My hypothesis is that Céline Dion's songs are more positive than Madonna's.

```{r message = FALSE, warning = FALSE, include = FALSE}
library(tidyverse)
library(geniusr)
library(dplyr)
library(tidytext)
library(wordcloud)
library(RColorBrewer)
library(wesanderson)
library(ggplot2)
library(ggridges)
library(ggthemes)
library(kableExtra)
library(plotly)
library(topicmodels)
```


```{r include = FALSE}
client_id <- 'T7Kc5EZ5k5AdOnxbwIj_jm8TCNZdmepT5ewvpY3jqVQRFhGvb7-xjd0kqvvo5MyB'
client_secret <- 'hJfLnMAvqNZNZ0qlFG22Akpy5lvtHmKionPdkPTyTcVvyrEYnEMF_jLt6InS3EzgA7p_6QBhegJxxY9sykFx8Q'
client_access_token <- 'KyIEPZ3RyqZEJq0RCnncWX8IOk5uDlD1B-Z8S8TWxHPt_Owm_P4YNHwz0KHZbn_i'
GENIUS_API_TOKEN <- 'KyIEPZ3RyqZEJq0RCnncWX8IOk5uDlD1B-Z8S8TWxHPt_Owm_P4YNHwz0KHZbn_i'
```

```{r message = FALSE, warning = FALSE, include = FALSE}
# let's try the without API version
install.packages("genius")
library(genius)
```

**Data engineering, exploration**

Creating individual datasets for further analysis for both Céline Dion and Madonna

```{r include = FALSE}
# getting the data
test <- genius_album(artist = "Céline Dion", album= "All the Way... A Decade of Song")

# tokenizing so that each row is one word
unnested <- test %>%
  unnest_tokens(word, lyric)

# getting rid of stop words
celine_df <- unnested %>% 
  anti_join(stop_words)

# writing to .csv to be safe
write_csv(celine_df, "celine_text.csv")
```

For Madonna

```{r include = FALSE}
#getting the data
madonna <- genius_album(artist = 'Madonna', album = 'Ray of Light')

# tokenizing so that each row is one word
madonna <- madonna %>%
  unnest_tokens(word, lyric)

#At this point I am adding "ba" to the stop words, because I feel that this word - no matter how frequently it is used by Madonna- will shift my analysis.

custom_stop_words <- bind_rows(tibble(word = c("ba"),
                                      lexicon = c("custom")),
                               stop_words)

# getting rid of stop words
madonna_df <- madonna %>% 
  anti_join(custom_stop_words)

# writing to .csv to be safe
write_csv(madonna_df, "madonna_text.csv")
```


Getting the two albums in one dataframe 

```{r message = FALSE, warning = FALSE}
artist_albums <- tribble(
  ~artist, ~album,
  "Céline Dion", "All the Way... A Decade of Song",
  "Madonna", "Ray of Light"
)

df <- artist_albums %>%
  add_genius(artist, album)

# unnesting so that each word is a row
unnested_df <- df %>%
  unnest_tokens(word, lyric)
unnested_df

# removing stop words
df2 <- unnested_df %>% 
  anti_join(custom_stop_words)

# writing to csv in case I lose connection at further steps
write_csv(df2,"Céline_Madonna_data.csv" )

df2
```

```{r}
# separate df for Céline D
celine <- filter(df2,artist == "Céline Dion")
```

```{r}
# separate df for Madonna
madonna <- filter(df2, artist == "Madonna")
madonna = madonna[-1,]
```


First step of the analysis :

Count most common words as a whole

```{r}
df3 <- df2 %>%
  count(word, sort = TRUE) 
df3
```

Love is by far the most common word, the second place belongs to "heart" followed by "baby" .


We can also visualize these words, to see the weight and the differences better.
For now we are only looking at words that are present more than 21 times.

```{r}
df2 %>%
  count(word, sort = TRUE) %>%
  filter( n > 21) %>% 
    mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "pink") +
  xlab(NULL) +
  coord_flip() +
  ggtitle("Most common words")
```


Looking at the individual datasets, shows us Céline Dion uses the word "love" much more often, than Madonna.
In fact, for Madonna it is not even in top 10 most frequently used words.

```{r}
celine_rank<- celine %>%
  count(word, sort = TRUE) 
celine_rank
```

```{r}
madonna_rank <- madonna %>% 
  count(word, sort = TRUE)
madonna_rank
```

**Sentiment Analysis using various lexicons**

Now let's look at the sentiments that can be found in the two albums.


```{r}
#let's see what sentiments there are in the nrc lexicon

nrc_sentiments <- get_sentiments("nrc")

df_sentiments <- df2 %>% 
  inner_join(nrc_sentiments)
  #count(word, sort = TRUE)
df_sentiments
```

```{r}
df_sentiments %>% 
  count(word,sentiment,sort=TRUE) %>%
group_by(sentiment)%>%top_n(n=5) %>% 
ungroup() %>%
  ggplot(aes(x=reorder(word,n),y=n,fill=sentiment)) + 
  geom_col(show.legend = FALSE) + 
  facet_wrap(~sentiment,scales="free") + 
  coord_flip() +
  ggtitle("Sentiments and Contributing Words")
```

We can see that there is a wide variety of sentiments in the combined dataset of the two albums.


What sentiments do we find if we filter to the individual artists?

```{r}
celine_sentiments <- celine %>% 
  inner_join(nrc_sentiments)

celine_sentiments %>% 
  count(word,sentiment,sort=TRUE) %>%
group_by(sentiment)%>%top_n(n=5) %>% 
ungroup() %>%
  ggplot(aes(x=reorder(word,n),y=n,fill=sentiment)) + 
  geom_col(show.legend = FALSE) + 
  facet_wrap(~sentiment,scales="free") + 
  coord_flip() +
  ggtitle("Sentiments Céline Dion")
```


```{r}
madonna_sentiments <- madonna %>% 
  inner_join(nrc_sentiments)

madonna_sentiments %>% 
  count(word,sentiment,sort=TRUE) %>%
group_by(sentiment)%>%top_n(n=5) %>% 
ungroup() %>%
  ggplot(aes(x=reorder(word,n),y=n,fill=sentiment)) + 
  geom_col(show.legend = FALSE) + 
  facet_wrap(~sentiment,scales="free") + 
  coord_flip() +
  ggtitle("Sentiments Madonna")
```

While these graphs look nice, in our case they are not very handy, I am not able to draw any conclusions from the words used by the artists contributing to the various sentiments.


So I will now focus on positive and negative sentiments only.

```{r}
# select positive sentiments

nrc_pos <- get_sentiments("nrc") %>% 
  filter(sentiment == "positive")

# join with df by "word"

df_pos <- df2 %>% 
  inner_join(nrc_pos) %>% 
  count(word, sort = TRUE)
```

Visualize positive words:

```{r}
df_pos %>%
  #count(word, sort = TRUE) %>%
  filter( n > 6) %>% 
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "pink") +
  xlab(NULL) +
  coord_flip()
```

If we look at the positive words, again we can see that love is the most frequent by far, followed by "baby", "faith" and "sky".
The list of the three "sky" related words is actually quite interesting, "sky", "sun" and "star" being the 4th-7th most frequent. I would have assumned kiss and feeling to be used more frequently than the above mentioned 3 words.

So whom do these positive words belong to?
My guess is, that love is mentioned more by Céline Dion ( which we have already seen), and faith, kiss, angel will also be mentioned more by her.

Let's see:

```{r}
celine_pos <- df2 %>% 
  filter( artist == "Céline Dion") %>% 
  inner_join(nrc_pos) %>% 
  count(word, sort = TRUE)

celine_pos
```


The top 5 pos words for Céline are: love, baby, faith, angel, sky.

```{r}
madonna_pos <- df2 %>% 
  filter(artist == "Madonna") %>% 
  inner_join(nrc_pos) %>% 
  count(word, sort = TRUE)

madonna_pos
```

The top 5 pos words for Madonna are: love ( although much less frequently), star, traveling, sky and swim. Wow! That is rather in the range of activeness.Well Madonna has always been one of those real energetic artists as far as I know.


Let's see the negative words as well.

```{r}
nrc_neg <- get_sentiments("nrc") %>% 
  filter(sentiment == "negative")

df_neg <- df2 %>% 
  inner_join(nrc_neg) %>% 
  count(word, sort = TRUE)
```

Top negative sentiment words visualized:

```{r}
df_neg %>%
  #count(word, sort = TRUE) %>%
  filter( n > 5) %>% 
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "grey") +
  xlab(NULL) +
  coord_flip()
```


Interesting finding that boy is considered negative.
It would be understandable had I been using bigram, to see that for example "Oh boy" is something negative.
But I am unsure why "boy" as a standalone is negative.


Let's count the most common positive and negative words using the ***bing*** lexicon, and look at their share.

```{r}
bing_word_counts <- df2 %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()
```

```{r}
bing_word_counts %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(y = "Contribution to sentiment",
       x = NULL) +
  coord_flip() +
  ggtitle("Top 10 Neg. & Pos. Sentiment Words")
```

```{r}
#remove this?
bing <- get_sentiments("bing")

counting_words <- df2 %>%
  inner_join(bing) %>%
  count(word, sentiment, sort = TRUE)

head(counting_words)
```

We can also visualize how negative or positive the most frequently words are in the entire dataset.

```{r}
bing_word_counts %>% 
  filter(n > 5) %>% 
  mutate(n = ifelse(sentiment == "negative", -n , n)) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col() +
  coord_flip() +
  labs(y = "Sentiment Score")
```

The bing lexicon shows us a quite string shift to the positive part with "love" leading the way, by a large bit.
The negative sentiment words here are a bit more in line with my "assumptions", such as : "broken", "blame", "cry".

Visualizing individually by artist:

```{r}
celine_bing <- celine_df %>%
  inner_join(bing) %>%
  count(word, sentiment, sort = TRUE)

celine_bing %>% 
  filter(n > 5) %>% 
  mutate(n = ifelse(sentiment == "negative", -n , n)) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col() +
  coord_flip() +
  labs(y = "Sentiment Score") +
  ggtitle("Sentiment for Céline Dion freq. > 5")
```

And here is one of the most important points I wanted to make. 
Céline Dion's songs, by the bing lexicon are much more in the positive range, when filtered to words that are more frequent than 5.

```{r}
madonna_bing <- madonna_df %>% 
  inner_join(bing) %>% 
  count(word, sentiment, sort = TRUE)

madonna_bing %>% 
  filter(n > 5) %>%
  mutate(n = ifelse(sentiment == "negative", -n , n)) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col() +
  coord_flip() +
  labs(y = "Sentiment Score") +
  ggtitle("Sentiment for Madonna freq > 5")
```

For Madonna, we can see that there are only 4 words that appear more than 5 times, so I will also create a chart with words mentioned more than twice.
But even this way, we can see that Madonna seems to be a bit less positive than Céline Dion.

```{r}
madonna_bing <- madonna_df %>% 
  inner_join(bing) %>% 
  count(word, sentiment, sort = TRUE)

madonna_bing %>% 
  filter(n > 2) %>%
  mutate(n = ifelse(sentiment == "negative", -n , n)) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col() +
  coord_flip() +
  labs(y = "Sentiment Score") +
  ggtitle("Sentiment for Madonna freq. > 2")
```

If we look at this graph, we can see some shift to the negative side, with only 3 words being positive among the 10 words, that are used more than twice.

Just to have a correct comparison, let's check this for Céline Dion as well.

```{r}
celine_bing <- celine_df %>% 
  inner_join(bing) %>% 
  count(word, sentiment, sort = TRUE)

celine_bing %>% 
  filter(n > 2) %>%
  mutate(n = ifelse(sentiment == "negative", -n , n)) %>% 
  mutate(word = reorder(word, n)) %>% 
  ggplot(aes(word, n, fill = sentiment)) + 
  geom_col() +
  coord_flip() +
  labs(y = "Sentiment Score") +
  ggtitle("Sentiment for Céline D freq. > 2")
```

In this case we see 17 words, out of which 11 are positive according to the bing lexicon.

**Wordclouds**

Let us create some wordclouds now, to check which are the most commonly used words for these two artists.
We have looked into this previously, but it can be seen better visually.

```{r include = FALSE}
# wordcloud
library(wordcloud)
library(RColorBrewer)
library(wesanderson)
wes_palette("GrandBudapest2")
```

```{r}
# for Céline Dion

df2 %>%
  filter(artist == "Céline Dion") %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 20, color = c(wes_palettes$GrandBudapest2[3:1])))
```

Céline Dion is all about love :) But in general, from a bird's eye view, her words, are really a lot more emotional and positive.

```{r warning = FALSE}
# for Madonna

df2 %>%
  filter(artist == "Madonna") %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 18, color = c(wes_palettes$GrandBudapest1 [3:1])))
```

As for Madonna? I think it's energy, movement, being active.

I would refrain from stating anything too harshly but Céline Dion seems to be more of a "thinker" whereas Madonna more of a "do-er" type of person. ( at least in these albums )

```{r}
library(reshape2)
madonna_bing %>% 
  count(word,sentiment, sort= TRUE) %>% 
  acast(word ~ sentiment, value.var = "n", fill = 0) %>% 
  comparison.cloud(colors= c("gray20", "gray80"),
                   max.words= 120)
```

```{r}
celine_bing %>% 
  count(word,sentiment, sort= TRUE) %>% 
  acast(word ~ sentiment, value.var = "n", fill = 0) %>% 
  comparison.cloud(colors= c("gray20", "gray80"),
                   max.words= 120)
```


**Tf-idf**

I will now use the stringr library to produce my tf_idf charts.
Tf-idf helps to define what are the most important words used by the artists.


```{r}
library(stringr)

# create td idf dataframe

df2_tf_idf <- df2 %>%
  count(artist, word) %>%
  filter(!str_detect(word, "\\d+")) %>%
  bind_tf_idf(word, artist, n) %>%
  arrange(-tf_idf)

# create tf-idf chart

df2_tf_idf %>%    
  arrange(desc(tf_idf)) %>%
  mutate(word = factor(word, levels = rev(unique(word)))) %>% 
  group_by(artist) %>% 
  top_n(10) %>% 
  ungroup %>%
  ggplot(aes(word, tf_idf, fill = artist)) +
  geom_col(show.legend = FALSE) +
  labs(x = NULL, y = "tf-idf") +
  facet_wrap(~artist, ncol = 2, scales = "free") +
  coord_flip() +
  ggtitle("What's important?")
```

Tf-idf will show how important one words is for the tww artists.
Again we can see that the topics that arise as "important" for Céline Dion are more in the romantic- dreamy field, whereas for Madonna it is much more down to Earth, and less about emotions.

Below I will create a graph that will explicitly show which artist is more positive by the "nrc" lexicon:


```{r}
sentiment_count <- df2 %>% 
  inner_join(get_sentiments("nrc"), by = "word") %>% 
  count(sentiment, artist) %>% 
  spread(sentiment, n, fill = 0)


sentiment_count %>%
  mutate(score = (positive - negative) / (positive + negative)) %>%
  mutate(artist = reorder(artist, score)) %>%
  ggplot(aes(artist, score, fill = score > 0)) +
  geom_col(show.legend = FALSE, fill = "pink") +
  coord_flip() +
  labs(x = "Artist",
       y = "Positivity score among artists") +
  ggtitle("Who is more positive?")
```

We can see that Céline Dion has a much higher positivity score, than Madonna.

**LDA- Topic Modelling**

Let's see what different topics lie within the lines of these songs, using Latent Dirichlet Allocation.
I will be creating 2 topics, and see what type of words I get in each.


```{r}
topics <- LDA(cast_dtm(data = df2 %>% 
               count(artist, word) %>% 
               ungroup(),
             term = word,
             document = artist, 
             value = n),
    k = 2, control = list(seed = 42)) %>% 
  tidy(matrix = "beta") %>% 
  group_by(topic) %>%
  arrange(desc(beta)) %>% 
  top_n(12, beta) %>% 
  ungroup()
topics %>% 
  arrange(topic, -beta) %>% 
  mutate(term = reorder(term, beta)) %>% 
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = 'free') +
  coord_flip() +
  ggtitle(" Topic modeling using LDA")
```

Using topic modelling, we are able to make the distinction between Madonna's and Céline Dion's "words".
It is clearly visible that Madonna's words were collected into one of the topics, a topic that to me seems much more down to Earth, versus Céline Dion's collection of words which are much more about feelings, than activity.

**Conclusion**

Materials used:

[Tidytext book] (https://www.tidytextmining.com/tfidf.html)

[Taylor Swift song analysis] (https://github.com/simranvatsa/tayloR/blob/master/tayloR_final.R)

[Wordcloud Fundamentals] (http://www.sthda.com/english/wiki/text-mining-and-word-cloud-fundamentals-in-r-5-simple-steps-you-should-know)

[Text Analysis from former student] (https://github.com/thegrigorian/TextAnalysisWithGutenberg)

[Song Analysis from former student ] (https://github.com/BenceToth/nlp_songlyrics/blob/master/DS4_final-assignment_Bence-L-Toth_166504.rmd)

[Genius package for R] (https://github.com/JosiahParry/genius)




